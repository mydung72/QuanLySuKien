@using EventBookingWeb.Models.Enums
@model EventBookingWeb.ViewModels.Admin.BookingManagementViewModel
@{
    ViewData["Title"] = "Quản lý đặt chỗ";
    Layout = "_AdminLayout";
    var events = ViewBag.Events as List<EventBookingWeb.Models.DomainModels.DBEvent> ?? new List<EventBookingWeb.Models.DomainModels.DBEvent>();
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1">Quản lý đặt chỗ</h4>
        <p class="text-muted mb-0">Theo dõi và quản lý tất cả các đơn đặt chỗ</p>
    </div>
</div>

<!-- Filter Card -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" asp-action="Index" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Sự kiện</label>
                <select name="filterEventId" class="form-select">
                    <option value="">Tất cả sự kiện</option>
                    @foreach (var e in events)
                    {
                        if (Model.FilterEventId == e.EventId)
                        {
                            <option value="@e.EventId" selected>@e.Title</option>
                        }
                        else
                        {
                            <option value="@e.EventId">@e.Title</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Trạng thái</label>
                @{
                    var statusValues = new[] {
                        new { Value = "", Text = "Tất cả", Status = (PaymentStatus?)null },
                        new { Value = "0", Text = "Chờ thanh toán", Status = (PaymentStatus?)PaymentStatus.Pending },
                        new { Value = "1", Text = "Đã đặt chỗ", Status = (PaymentStatus?)PaymentStatus.Reserved },
                        new { Value = "2", Text = "Đã thanh toán", Status = (PaymentStatus?)PaymentStatus.Paid },
                        new { Value = "3", Text = "Đã hủy", Status = (PaymentStatus?)PaymentStatus.Cancelled },
                        new { Value = "4", Text = "Đã hoàn tiền", Status = (PaymentStatus?)PaymentStatus.Refunded }
                    };
                }
                <select name="filterStatus" class="form-select">
                    @foreach (var item in statusValues)
                    {
                        if (Model.FilterStatus == item.Status)
                        {
                            <option value="@item.Value" selected>@item.Text</option>
                        }
                        else
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Từ ngày</label>
                <input type="date" name="filterStartDate" class="form-control" value="@Model.FilterStartDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Đến ngày</label>
                <input type="date" name="filterEndDate" class="form-control" value="@Model.FilterEndDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Tìm kiếm</label>
                <input type="text" name="searchTerm" class="form-control" placeholder="Tên, email..." value="@Model.SearchTerm" />
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary d-block w-100">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bookings Table -->
<div class="card">
    <div class="card-body">
        @if (Model.Bookings.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Mã ĐC</th>
                            <th>Sự kiện</th>
                            <th>Khách hàng</th>
                            <th>Số lượng</th>
                            <th>Tổng tiền</th>
                            <th>Thanh toán</th>
                            <th>Ngày đặt</th>
                            <th>Trạng thái</th>
                            <th class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model.Bookings)
                        {
                            <tr>
                                <td><strong>#@booking.BookingId</strong></td>
                                <td>
                                    <span class="text-truncate d-inline-block" style="max-width: 200px;" title="@booking.EventTitle">
                                        @booking.EventTitle
                                    </span>
                                </td>
                                <td>
                                    <strong>@booking.UserName</strong>
                                    <br>
                                    <small class="text-muted">@booking.UserEmail</small>
                                </td>
                                <td>@booking.Quantity vé</td>
                                <td><strong class="text-primary">@booking.TotalAmount.ToString("N0") đ</strong></td>
                                <td><span class="badge bg-secondary">@booking.PaymentMethod</span></td>
                                <td>@booking.BookingDate.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    @{
                                        var statusClass = booking.PaymentStatus switch
                                        {
                                            PaymentStatus.Pending => "bg-warning",
                                            PaymentStatus.Reserved => "bg-info",
                                            PaymentStatus.Paid => "bg-success",
                                            PaymentStatus.Cancelled => "bg-danger",
                                            PaymentStatus.Refunded => "bg-secondary",
                                            _ => "bg-secondary"
                                        };
                                        var statusText = booking.PaymentStatus switch
                                        {
                                            PaymentStatus.Pending => "Chờ thanh toán",
                                            PaymentStatus.Reserved => "Đã đặt chỗ",
                                            PaymentStatus.Paid => "Đã thanh toán",
                                            PaymentStatus.Cancelled => "Đã hủy",
                                            PaymentStatus.Refunded => "Đã hoàn tiền",
                                            _ => "Không xác định"
                                        };
                                    }
                                    <span class="badge @statusClass">@statusText</span>
                                </td>
                                <td class="text-center">
                                    <a asp-action="Details" asp-route-id="@booking.BookingId" class="btn btn-sm btn-outline-info" title="Chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (Model.TotalPages > 1)
            {
                <nav class="mt-3">
                    <ul class="pagination justify-content-center mb-0">
                        @if (Model.CurrentPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=@(Model.CurrentPage - 1)&filterEventId=@Model.FilterEventId&filterStatus=@((int?)Model.FilterStatus)&filterStartDate=@Model.FilterStartDate?.ToString("yyyy-MM-dd")&filterEndDate=@Model.FilterEndDate?.ToString("yyyy-MM-dd")&searchTerm=@Model.SearchTerm">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        }
                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="?page=@i&filterEventId=@Model.FilterEventId&filterStatus=@((int?)Model.FilterStatus)&filterStartDate=@Model.FilterStartDate?.ToString("yyyy-MM-dd")&filterEndDate=@Model.FilterEndDate?.ToString("yyyy-MM-dd")&searchTerm=@Model.SearchTerm">@i</a>
                            </li>
                        }
                        @if (Model.CurrentPage < Model.TotalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=@(Model.CurrentPage + 1)&filterEventId=@Model.FilterEventId&filterStatus=@((int?)Model.FilterStatus)&filterStartDate=@Model.FilterStartDate?.ToString("yyyy-MM-dd")&filterEndDate=@Model.FilterEndDate?.ToString("yyyy-MM-dd")&searchTerm=@Model.SearchTerm">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        }
        else
        {
            <div class="text-center py-5">
                <i class="bi bi-ticket-perforated display-1 text-muted"></i>
                <h5 class="mt-3 text-muted">Không tìm thấy đặt chỗ nào</h5>
                <p class="text-muted">Thử thay đổi bộ lọc để xem kết quả khác</p>
            </div>
        }
    </div>
</div>

